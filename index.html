<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>競走馬・オリウマ プロフィールメーカー v1.3.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* Light Theme Colors */
            --bg-page: #f0f2f5; --bg-container: #ffffff; --bg-light: #f7f7f7; --bg-header: #f0f0f0; --text-primary: #333333; --text-secondary: #666666; --border-color: #dddddd;
            --color-father: #004098; --color-mother: #e60012; --color-g1: #004098; --color-g2: #e60012; --color-g3: #009944; --color-listed: #660099; --color-other: #6c757d; --color-edit: #007bff; --color-delete: #dc3545; --color-success: #28a745;
            --rank1-bg: #ffea80; --rank2-bg: #b3e5fc; --rank3-bg: #ffcc80;
        }

        body.dark-mode {
            /* Dark Theme Colors */
            --bg-page: #121212; --bg-container: #1e1e1e; --bg-light: #2c2c2e; --bg-header: #2c2c2e; --text-primary: #e0e0e0; --text-secondary: #aaaaaa; --border-color: #444444;
            --color-father: #58a6ff; --color-mother: #ff7b72; --color-g1: #58a6ff; --color-g2: #ff7b72; --color-g3: #56d364; --color-listed: #c678dd; --color-other: #8b949e; --color-edit: #58a6ff; --color-delete: #ff7b72; --color-success: #56d364;
            --rank1-bg: #ffd700; --rank2-bg: #58a6ff; --rank3-bg: #cd7f32;
        }
        
        html { scroll-behavior: smooth; }
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; margin: 0; padding: 0; background-color: var(--bg-page); color: var(--text-primary); font-size: 14px; transition: background-color 0.2s, color 0.2s; }
        
        #theme-toggle { position: fixed; top: 15px; right: 20px; z-index: 1001; background: none; border: none; cursor: pointer; padding: 5px; background-color: var(--bg-container); border: 1px solid var(--border-color); border-radius: 50%; width: 32px; height: 32px; }
        #theme-toggle svg { width: 20px; height: 20px; fill: var(--text-primary); }
        body.dark-mode #theme-toggle .sun { display: block; } body.dark-mode #theme-toggle .moon { display: none; }
        body:not(.dark-mode) #theme-toggle .sun { display: none; } body:not(.dark-mode) #theme-toggle .moon { display: block; }

        .page-header { background-color: var(--bg-container); padding: 10px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .page-header h1 { font-size: 20px; margin: 0; color: var(--text-primary); }
        .page-header .version { font-size: 12px; color: var(--text-secondary); margin-left: 8px; font-weight: normal; }
        .github-link { display: flex; align-items: center; text-decoration: none; color: var(--color-father); }
        .github-link svg { width: 20px; height: 20px; margin-right: 5px; fill: currentColor; }
        .github-link:hover { text-decoration: underline; }

        .container { display: flex; gap: 20px; max-width: 1600px; margin: 20px auto; flex-wrap: wrap; padding: 0 20px; }
        .input-area { flex: 1; min-width: 320px; background-color: var(--bg-container); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .preview-area { flex: 2; min-width: 320px; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; color: white; cursor: pointer; transition: opacity 0.2s; font-size: 12px; }
        .btn:hover { opacity: 0.8; }
        .btn-primary { background-color: var(--color-father); } .btn-success { background-color: var(--color-success); }
        .btn-edit { background-color: var(--color-edit); } .btn-delete { background-color: var(--color-delete); }
        .io-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .toast-message { background-color: var(--color-success); color: white; padding: 15px; border-radius: 5px; margin-bottom: 10px; opacity: 0; transform: translateX(100%); transition: all 0.4s ease-in-out; }
        .toast-message.show { opacity: 1; transform: translateX(0); }
        .input-area h2, .input-area h3 { margin-top: 0; color: var(--text-primary); }
        .input-area h2 { border-bottom: 2px solid var(--color-father); padding-bottom: 5px; }
        .form-section { margin-bottom: 20px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: bold; color: var(--text-primary); }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--bg-container); color: var(--text-primary); }
        .form-group input[readonly] { background-color: var(--bg-light); }
        .form-row { display: flex; gap: 10px; } .form-row > * { flex: 1; }
        #add-race-btn { width: 100%; padding: 10px; font-size: 16px; }
        .radio-group label { display: inline-block; font-weight: normal; margin-bottom: 0; margin-right: 15px; vertical-align: middle; }
        .radio-group input[type="radio"] { width: auto; vertical-align: middle; margin-right: 4px; }
        .preview-box { background-color: var(--bg-container); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #responsive-message { display: none; width: 100%; text-align: center; padding: 10px; background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; border-radius: 4px; margin-bottom: 15px; box-sizing: border-box; }
        .profile-table { width: 100%; border-collapse: collapse; }
        .profile-table th, .profile-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
        .profile-table th { width: 120px; background-color: var(--bg-light); font-weight: normal; }
        .pedigree-box { display: flex; }
        .pedigree-label { padding: 4px 8px; color: white; border-radius: 4px; margin-right: 8px; font-size: 12px; }
        .father-label { background-color: var(--color-father); } .mother-label { background-color: var(--color-mother); }
        .pedigree-name { font-weight: bold; font-size: 16px; }
        .pedigree-sire { font-size: 12px; color: var(--text-secondary); }
        .results-header { padding: 12px; background-color: var(--bg-header); border-bottom: 1px solid var(--border-color); font-size: 16px; font-weight: bold; color: var(--text-primary); }
        .results-table { width: 100%; border-collapse: collapse; text-align: center; }
        .results-table th, .results-table td { padding: 10px 5px; border-top: 1px solid var(--border-color); color: var(--text-primary); }
        .race-name { text-align: left; padding-left: 10px; }
        .race-grade { display: inline-block; padding: 2px 6px; color: white; border-radius: 4px; font-size: 10px; margin-left: 5px; }
        .grade-g1 { background-color: var(--color-g1); } .grade-g2 { background-color: var(--color-g2); } .grade-g3 { background-color: var(--color-g3); } .grade-l { background-color: var(--color-listed); } .grade-op, .grade-other { background-color: var(--color-other); }
        .action-buttons { display: flex; gap: 5px; justify-content: center; }
        .export-clone { position: absolute; left: -9999px; top: 0; width: 1200px !important; z-index: -1; }
        .cell-rank-1 { background-color: var(--rank1-bg); } .cell-rank-2 { background-color: var(--rank2-bg); } .cell-rank-3 { background-color: var(--rank3-bg); }
        
        body.dark-mode .pedigree-label,
        body.dark-mode .race-grade,
        body.dark-mode .cell-rank-1,
        body.dark-mode .cell-rank-2,
        body.dark-mode .cell-rank-3 { color: #121212; }

        .force-light-theme {
            --bg-page: #f0f2f5; --bg-container: #ffffff; --bg-light: #f7f7f7; --bg-header: #f0f0f0; --text-primary: #333333; --text-secondary: #666666; --border-color: #dddddd;
            --color-father: #004098; --color-mother: #e60012; --color-g1: #004098; --color-g2: #e60012; --color-g3: #009944; --color-listed: #660099; --color-other: #6c757d;
            --rank1-bg: #ffea80; --rank2-bg: #b3e5fc; --rank3-bg: #ffcc80;
        }
        .export-clone.force-light-theme .pedigree-label,
        .export-clone.force-light-theme .race-grade { color: white; }
        .export-clone.force-light-theme .results-table td { color: var(--text-primary); }

        @media (max-width: 900px) { .container { flex-direction: column; margin-top: 10px; } #theme-toggle { top: 70px; } }
        @media (max-width: 600px) { .page-header { flex-direction: column; gap: 10px; } #theme-toggle { top: 110px; } }
    </style>
</head>
<body>
    <button id="theme-toggle" title="テーマを切り替え">
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12Zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8ZM11 1h2v3h-2V1Zm0 19h2v3h-2v-3ZM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93ZM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121Zm2.121-14.85-1.414-1.414-2.121 2.121 1.414 1.414 2.121-2.121ZM5.636 16.95l-2.121 2.121 1.414 1.414 2.121-2.121-1.414-1.414ZM23 11v2h-3v-2h3ZM4 11v2H1v-2h3Z"/></svg>
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.99 2.007a9.993 9.993 0 0 1 8.12 15.47a.75.75 0 0 0-.012 1.06a.75.75 0 0 0 1.06.013A11.492 11.492 0 0 0 12.001 0C5.372 0 0 5.373 0 12a11.492 11.492 0 0 0 4.542 9.475a.75.75 0 0 0 1.06-.012a.75.75 0 0 0-.012-1.06A9.993 9.993 0 0 1 3.007 12A9.993 9.993 0 0 1 11.99 2.007Z"/></svg>
    </button>
    <header class="page-header">
        <h1>競走馬・オリウマ プロフィールメーカー<span class="version">v1.3.2</span></h1>
        <a href="https://github.com/Tank-x3/Horses_Profiles_Maker" target="_blank" rel="noopener noreferrer" class="github-link">
            <svg viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            <span>GitHub (使い方/Readme)</span>
        </a>
    </header>
    <div class="container">
        <div id="responsive-message">プレビューエリアが入力エリアの下に表示されています。画面幅を広げると見やすくなります。</div>
        <div class="input-area">
            <h2>入力フォーム</h2>
            <div class="form-section">
                <h3>データ管理</h3>
                <div class="io-buttons">
                    <button id="save-json-btn" class="btn btn-primary">データを保存</button>
                    <button id="load-json-btn" class="btn btn-success">データを読み込み</button>
                    <input type="file" id="json-file-input" accept=".json" style="display: none;">
                </div>
            </div>
            <div class="form-section">
                <h3>画像として出力</h3>
                <div class="io-buttons">
                    <button id="export-all-btn" class="btn btn-primary">結合</button>
                    <button id="export-profile-btn" class="btn btn-primary">基本情報のみ</button>
                    <button id="export-results-btn" class="btn btn-primary">成績表のみ</button>
                </div>
            </div>
            <div class="form-section">
                <h3>モード選択</h3>
                <div class="form-group radio-group">
                    <input type="radio" id="mode-fictional" name="mode" value="fictional" checked> <label for="mode-fictional">架空馬</label>
                    <input type="radio" id="mode-original" name="mode" value="original"> <label for="mode-original">オリウマ</label>
                </div>
            </div>
            <div id="basic-info-forms">
                <div id="form-fictional" class="form-section">
                    <h3>基本情報 (架空馬)</h3>
                    <div class="form-group"><label for="f-horseName">馬名</label><input type="text" id="f-horseName"></div>
                    <div class="form-group"><label for="f-horseNameEn">欧字馬名</label><input type="text" id="f-horseNameEn"></div>
                    <div class="form-group"><label for="f-father">父名</label><input type="text" id="f-father"></div>
                    <div class="form-group"><label for="f-mother">母名</label><input type="text" id="f-mother"></div>
                    <div class="form-group"><label for="f-bms">母父名</label><input type="text" id="f-bms"></div>
                    <div class="form-group"><label for="f-sexAge">性齢</label><input type="text" id="f-sexAge"></div>
                    <div class="form-group"><label for="f-affiliation">所属</label><div class="form-row"><select id="f-affiliationSelect"><option value="美浦">美浦</option><option value="栗東">栗東</option><option value="地方">地方</option><option value="海外">海外</option></select><input type="text" id="f-affiliationText" placeholder="厩舎名など"></div></div>
                    <div class="form-group"><label for="f-owner">馬主</label><input type="text" id="f-owner"></div>
                    <div class="form-group"><label for="f-breeder">生産者</label><input type="text" id="f-breeder"></div>
                    <div class="form-group"><label for="f-totalResults">通算成績 (自動計算)</label><input type="text" id="f-totalResults" readonly></div>
                    <div class="form-group"><label for="f-totalPrize">総獲得賞金 (自動計算)</label><input type="text" id="f-totalPrize" readonly></div>
                    <div class="form-group"><label for="f-mainWin">主な勝ち鞍</label><input type="text" id="f-mainWin"></div>
                    <div class="form-group"><label for="f-birthday">生年月日</label><input type="date" id="f-birthday"></div>
                    <div class="form-group"><label for="f-meaning">馬名の意味</label><input type="text" id="f-meaning"></div>
                    <div class="form-group"><label for="f-nextRace">次走予定</label><input type="text" id="f-nextRace"></div>
                </div>
                <div id="form-original" class="form-section" style="display:none;">
                    <h3>基本情報 (オリウマ)</h3>
                    <div class="form-group"><label for="o-name">名前</label><input type="text" id="o-name"></div>
                    <div class="form-group"><label for="o-nameEn">欧字名</label><input type="text" id="o-nameEn"></div>
                    <div class="form-group"><label for="o-ear">耳飾り</label><select id="o-ear"><option value="右">右</option><option value="左">左</option><option value="両">両</option><option value="なし">なし</option></select></div>
                    <div class="form-group"><label for="o-grade">学年</label><select id="o-grade"><option value="中等部">中等部</option><option value="中等部1年">中等部1年</option><option value="中等部2年">中等部2年</option><option value="中等部3年">中等部3年</option><option value="高等部">高等部</option><option value="高等部1年">高等部1年</option><option value="高等部2年">高等部2年</option><option value="高等部3年">高等部3年</option></select></div>
                    <div class="form-group"><label for="o-dorm">所属寮</label><div class="form-row"><select id="o-dormSelect"><option value="美浦">美浦</option><option value="栗東">栗東</option><option value="地方">地方</option><option value="海外">海外</option><option value="その他">その他</option><option value="">(空欄)</option></select><input type="text" id="o-dormText" placeholder="自由記述"></div></div>
                    <div class="form-group"><label for="o-totalResults">通算成績 (自動計算)</label><input type="text" id="o-totalResults" readonly></div>
                    <div class="form-group"><label for="o-totalFans">累計ファン数 (自動計算)</label><input type="text" id="o-totalFans" readonly></div>
                    <div class="form-group"><label for="o-mainWin">主な勝ち鞍</label><input type="text" id="o-mainWin"></div>
                    <div class="form-group"><label for="o-birthday">生年月日</label><input type="date" id="o-birthday"></div>
                    <div class="form-group"><label for="o-meaning">名前の意味</label><input type="text" id="o-meaning"></div>
                    <div class="form-group"><label for="o-nextRace">次走予定</label><input type="text" id="o-nextRace"></div>
                </div>
            </div>
            <div class="form-section">
                <h3 id="race-form-header">レース成績</h3>
                <div class="form-group"><label for="race-date">開催日</label><input type="text" id="race-date" placeholder="22/06/05"></div>
                <div class="form-group"><label for="race-course">開催地</label><input type="text" id="race-course" placeholder="東京11R"></div>
                <div class="form-group"><label for="race-name">レース名</label><input type="text" id="race-name"></div>
                <div class="form-group"><label for="race-grade">格付け</label>
                    <select id="race-grade">
                        <option value="GⅠ">GⅠ</option><option value="JpnⅠ">JpnⅠ</option><option value="J・GⅠ">J・GⅠ</option>
                        <option value="GⅡ">GⅡ</option><option value="JpnⅡ">JpnⅡ</option><option value="J・GⅡ">J・GⅡ</option>
                        <option value="GⅢ">GⅢ</option><option value="JpnⅢ">JpnⅢ</option><option value="J・GⅢ">J・GⅢ</option>
                        <option value="L">L</option><option value="OP">OP</option><option value="3勝">3勝</option><option value="2勝">2勝</option><option value="1勝">1勝</option><option value="未勝利">未勝利</option><option value="新馬">新馬</option><option value="その他">その他</option>
                    </select>
                </div>
                <div class="form-group"><label for="race-distance">距離</label><input type="text" id="race-distance" placeholder="芝2400m"></div>
                <div class="form-row">
                    <div class="form-group"><label for="race-pop">人気</label><input type="number" id="race-pop" min="1"></div>
                    <div class="form-group"><label for="race-rank">着順</label><input type="number" id="race-rank" min="1"></div>
                </div>
                <div class="form-group" id="race-jockey-group"><label for="race-jockey">騎手</label><input type="text" id="race-jockey"></div>
                <div class="form-row" id="race-weight-odds-row">
                    <div class="form-group"><label for="race-weight">斤量</label><input type="text" id="race-weight" placeholder="56"></div>
                    <div class="form-group"><label for="race-odds">オッズ</label><input type="text" id="race-odds" placeholder="7.8"></div>
                </div>
                <div class="form-group" id="race-prize-group"><label for="race-prize">獲得賞金(万円)</label><input type="number" id="race-prize" min="0" placeholder="0"></div>
                <div class="form-group" id="race-fans-group" style="display:none;"><label for="race-fans">獲得ファン数</label><input type="number" id="race-fans" min="0" placeholder="0"></div>
                <button id="add-race-btn" class="btn btn-primary">成績を追加</button>
            </div>
        </div>
        <div class="preview-area" id="preview-area">
            <div class="preview-box" id="profile-preview-box"><table class="profile-table"><tbody id="preview-basic-info"></tbody></table></div>
            <div class="preview-box" id="results-preview-box">
                <div class="results-header">競走成績</div>
                <table class="results-table">
                    <thead id="results-table-head"></thead>
                    <tbody id="preview-results-table"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let appData = createInitialData();
        let editingIndex = null;
        function createInitialData() { return { mode: 'fictional', fictional: { horseName: '', horseNameEn: '', father: '', mother: '', bms: '', sexAge: '', affiliationSelect: '美浦', affiliationText: '', owner: '', breeder: '', totalResults: '', totalPrize: '', mainWin: '', birthday: '', meaning: '', nextRace: '' }, original: { name: '', nameEn: '', ear: '右', grade: '中等部', dormSelect: '美浦', dormText: '', totalResults: '', totalFans: '', mainWin: '', birthday: '', meaning: '', nextRace: '' }, races: [] }; }
        const inputArea = document.querySelector('.input-area');
        const addRaceBtn = document.getElementById('add-race-btn');
        inputArea.addEventListener('change', handleInputChange);
        inputArea.addEventListener('input', handleInputChange);
        addRaceBtn.addEventListener('click', handleAddOrUpdateRace);
        document.getElementById('save-json-btn').addEventListener('click', saveToJson);
        document.getElementById('load-json-btn').addEventListener('click', () => document.getElementById('json-file-input').click());
        document.getElementById('json-file-input').addEventListener('change', loadFromJson);
        document.getElementById('preview-results-table').addEventListener('click', handleRaceAction);
        document.getElementById('export-all-btn').addEventListener('click', () => exportImage(document.getElementById('preview-area'), 'all'));
        document.getElementById('export-profile-btn').addEventListener('click', () => exportImage(document.getElementById('profile-preview-box'), 'profile'));
        document.getElementById('export-results-btn').addEventListener('click', () => exportImage(document.getElementById('results-preview-box'), 'results'));

        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        if (savedTheme === 'dark') { body.classList.add('dark-mode'); }
        themeToggle.addEventListener('click', () => { body.classList.toggle('dark-mode'); localStorage.setItem('theme', body.classList.contains('dark-mode') ? 'dark' : 'light'); });

        function handleInputChange(e) { const target = e.target; if (!target.id) return; if (target.id.startsWith('f-') || target.id.startsWith('o-')) { appData[appData.mode][target.id.substring(2)] = target.value; } else if (target.name === 'mode') { appData.mode = target.value; } updateAllViews(); }
        
        function validateRaceData(data) {
            const errors = [];
            const pop = parseInt(data.pop, 10);
            const rank = parseInt(data.rank, 10);
            const prize = parseInt(data.prize, 10);
            const fans = parseInt(data.fans, 10);
            if (data.pop && pop <= 0) { errors.push("・人気は1以上の整数で入力してください。"); }
            if (data.rank && rank <= 0) { errors.push("・着順は1以上の整数で入力してください。"); }
            if (data.prize && prize < 0) { errors.push("・獲得賞金は0以上の整数で入力してください。"); }
            if (data.fans && fans < 0) { errors.push("・獲得ファン数は0以上の整数で入力してください。"); }
            if (errors.length > 0) { alert("入力内容を確認してください:\n\n" + errors.join("\n")); return false; }
            return true;
        }

        function handleAddOrUpdateRace() { const raceData = getRaceFormValues(); if (!validateRaceData(raceData)) { return; } if (editingIndex !== null) { appData.races[editingIndex] = raceData; } else { appData.races.unshift(raceData); } resetRaceForm(); updateAllViews(); }
        function handleRaceAction(e) { const target = e.target.closest('button'); if (!target) return; const index = parseInt(target.dataset.index, 10); if (target.classList.contains('btn-edit')) { startEditingRace(index); } else if (target.classList.contains('btn-delete')) { deleteRace(index); } }
        function startEditingRace(index) { editingIndex = index; setRaceFormValues(appData.races[index]); addRaceBtn.textContent = '成績を更新'; addRaceBtn.classList.replace('btn-primary', 'btn-success'); document.getElementById('race-form-header').scrollIntoView({ behavior: 'smooth', block: 'start' }); }
        function deleteRace(index) { if (confirm('このレース成績を削除しますか？')) { appData.races.splice(index, 1); resetRaceForm(); updateAllViews(); } }
        function saveToJson() { const dataStr = JSON.stringify(appData, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const fileNameBase = appData.mode === 'fictional' ? appData.fictional.horseName : appData.original.name; a.download = `${fileNameBase || 'profile'}.json`; a.href = url; a.click(); URL.revokeObjectURL(url); }
        function loadFromJson(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const loadedData = JSON.parse(event.target.result); appData = { ...createInitialData(), ...loadedData }; appData.races = appData.races.map(r => ({ ...{ prize: 0, fans: 0 }, ...r })); resetRaceForm(); loadDataIntoForms(); updateAllViews(); showToast('データの読み込みが完了しました。'); } catch (err) { alert('ファイルの読み込みに失敗しました。'); console.error(err); } }; reader.readAsText(file); e.target.value = ''; }
        
        function nextFrame() { return new Promise(resolve => { requestAnimationFrame(resolve); }); }
        async function exportImage(targetElement, suffix) {
            const fileNameBase = appData.mode === 'fictional' ? appData.fictional.horseName : appData.original.name;
            const fileName = `${fileNameBase || 'profile'}_${suffix}.png`;
            
            const clone = targetElement.cloneNode(true);
            clone.classList.add('export-clone', 'force-light-theme');
            document.body.appendChild(clone);
            showToast('画像を生成中です...');
            
            try {
                await nextFrame();
                const canvas = await html2canvas(clone, { scale: 2 });
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = fileName;
                a.click();
                showToast('画像の生成が完了しました。');
            } catch (error) {
                console.error('画像生成に失敗しました:', error);
                showToast('エラー: 画像の生成に失敗しました。');
            } finally {
                document.body.removeChild(clone);
            }
        }
        
        function showToast(message) { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = 'toast-message'; toast.textContent = message; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 100); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 3000); }
        function calculateTotals() {
            let wins = [0, 0, 0, 0]; // 1着, 2着, 3着, 4着以下
            let totalPrize = 0, totalFans = 0;
            appData.races.forEach(race => {
                const rank = parseInt(race.rank, 10);
                if (rank > 0) {
                    if (rank === 1) wins[0]++;
                    else if (rank === 2) wins[1]++;
                    else if (rank === 3) wins[2]++;
                    else wins[3]++;
                }
                totalPrize += parseInt(race.prize, 10) || 0;
                totalFans += parseInt(race.fans, 10) || 0;
            });
            const totalRaces = appData.races.length;
            const resultsStr = `${totalRaces}戦${wins[0]}勝 [${wins[0]}-${wins[1]}-${wins[2]}-${wins[3]}]`;
            document.getElementById('f-totalResults').value = resultsStr;
            document.getElementById('o-totalResults').value = resultsStr;
            document.getElementById('f-totalPrize').value = formatPrize(totalPrize);
            document.getElementById('o-totalFans').value = formatFans(totalFans);
        }
        function formatPrize(amount) { if (amount === 0) return '0万円'; if (amount < 10000) return `${amount.toLocaleString()}万円`; const oku = Math.floor(amount / 10000); const man = amount % 10000; return man === 0 ? `${oku}億円` : `${oku}億${man.toLocaleString()}万円`; }
        function formatFans(amount) { return `${amount.toLocaleString()}人`; }
        function updateAllViews() { calculateTotals(); updateFormVisibility(); updateBasicInfoPreview(); updateResultsPreview(); }
        function updateFormVisibility() {
            const isFictional = appData.mode === 'fictional';
            document.getElementById('form-fictional').style.display = isFictional ? 'block' : 'none';
            document.getElementById('form-original').style.display = isFictional ? 'none' : 'block';
            document.getElementById('race-prize-group').style.display = isFictional ? 'block' : 'none';
            document.getElementById('race-fans-group').style.display = isFictional ? 'none' : 'block';
            document.getElementById('race-jockey-group').style.display = isFictional ? 'block' : 'none';
            document.getElementById('race-weight-odds-row').style.display = isFictional ? 'flex' : 'none';
        }
        function updateBasicInfoPreview() { const container = document.getElementById('preview-basic-info'); const data = appData[appData.mode]; let html = ''; if (appData.mode === 'fictional') { const affiliation = [data.affiliationSelect, data.affiliationText].filter(Boolean).join(' '); html = `<tr><td colspan="2"><h2>${data.horseName || '馬名'} <small>${data.horseNameEn || ''}</small></h2></td></tr><tr><td colspan="2"><div class="pedigree-box"><span class="pedigree-label father-label">父</span><div><div class="pedigree-name">${data.father || '-'}</div></div></div></td></tr><tr><td colspan="2"><div class="pedigree-box"><span class="pedigree-label mother-label">母</span><div><div class="pedigree-name">${data.mother || '-'}</div><div class="pedigree-sire">母父: ${data.bms || '-'}</div></div></div></td></tr><tr><th>性齢</th><td>${data.sexAge || '-'}</td></tr><tr><th>所属</th><td>${affiliation || '-'}</td></tr><tr><th>馬主</th><td>${data.owner || '-'}</td></tr><tr><th>生産者</th><td>${data.breeder || '-'}</td></tr><tr><th>通算成績</th><td>${document.getElementById('f-totalResults').value || '-'}</td></tr><tr><th>総獲得賞金</th><td>${document.getElementById('f-totalPrize').value || '-'}</td></tr><tr><th>主な勝ち鞍</th><td>${data.mainWin || '-'}</td></tr><tr><th>生年月日</th><td>${data.birthday ? new Date(data.birthday + 'T00:00:00').toLocaleDateString('ja-JP') : '-'}</td></tr><tr><th>馬名の意味</th><td>${data.meaning || '-'}</td></tr><tr><th>次走予定</th><td>${data.nextRace || '-'}</td></tr>`; } else { const dorm = [data.dormSelect, data.dormText].filter(Boolean).join(' '); html = `<tr><td colspan="2"><h2>${data.name || '名前'} <small>${data.nameEn || ''}</small></h2></td></tr><tr><th>耳飾り</th><td>${data.ear || '-'}</td></tr><tr><th>学年</th><td>${data.grade || '-'}</td></tr><tr><th>所属寮</th><td>${dorm || '-'}</td></tr><tr><th>通算成績</th><td>${document.getElementById('o-totalResults').value || '-'}</td></tr><tr><th>累計ファン数</th><td>${document.getElementById('o-totalFans').value || '-'}</td></tr><tr><th>主な勝ち鞍</th><td>${data.mainWin || '-'}</td></tr><tr><th>生年月日</th><td>${data.birthday ? new Date(data.birthday + 'T00:00:00').toLocaleDateString('ja-JP') : '-'}</td></tr><tr><th>名前の意味</th><td>${data.meaning || '-'}</td></tr><tr><th>次走予定</th><td>${data.nextRace || '-'}</td></tr>`; } container.innerHTML = html; }
        function updateResultsPreview() {
            const thead = document.getElementById('results-table-head');
            const tbody = document.getElementById('preview-results-table');
            const isFictional = appData.mode === 'fictional';
            thead.innerHTML = isFictional ? `<tr><th>開催</th><th>レース名</th><th>距離</th><th>人気</th><th>着順</th><th>騎手</th><th>斤量</th><th>オッズ</th><th>操作</th></tr>` : `<tr><th>開催</th><th>レース名</th><th>距離</th><th>人気</th><th>着順</th><th>オッズ</th><th>操作</th></tr>`;
            tbody.innerHTML = '';
            appData.races.forEach((race, index) => {
                const gradeClass = getGradeClass(race.grade);
                const popClass = getRankClass(race.pop);
                const rankClass = getRankClass(race.rank);
                const tr = document.createElement('tr');
                if (isFictional) {
                    tr.innerHTML = `<td>${race.date || '-'}<br>${race.course || '-'}</td><td class="race-name">${race.name || '-'} <span class="race-grade ${gradeClass}">${race.grade || ''}</span></td><td>${race.distance || '-'}</td><td class="${popClass}">${race.pop || '-'}</td><td class="${rankClass}">${race.rank || '-'}</td><td>${race.jockey || '-'}</td><td>${race.weight || '-'}</td><td>${race.odds || '-'}</td><td><div class="action-buttons"><button class="btn btn-edit" data-index="${index}">編集</button><button class="btn btn-delete" data-index="${index}">削除</button></div></td>`;
                } else {
                    tr.innerHTML = `<td>${race.date || '-'}<br>${race.course || '-'}</td><td class="race-name">${race.name || '-'} <span class="race-grade ${gradeClass}">${race.grade || ''}</span></td><td>${race.distance || '-'}</td><td class="${popClass}">${race.pop || '-'}</td><td class="${rankClass}">${race.rank || '-'}</td><td>${race.odds || '-'}</td><td><div class="action-buttons"><button class="btn btn-edit" data-index="${index}">編集</button><button class="btn btn-delete" data-index="${index}">削除</button></div></td>`;
                }
                tbody.appendChild(tr);
            });
        }
        const raceFormIds = ['race-date', 'race-course', 'race-name', 'race-grade', 'race-distance', 'race-pop', 'race-rank', 'race-jockey', 'race-weight', 'race-odds', 'race-prize', 'race-fans'];
        function getRaceFormValues() { const v={}; raceFormIds.forEach(id=>v[id.replace('race-','')]=document.getElementById(id).value); return v; }
        function setRaceFormValues(data) { raceFormIds.forEach(id=>document.getElementById(id).value = data[id.replace('race-','')] || ''); }
        function resetRaceForm() { editingIndex = null; addRaceBtn.textContent = '成績を追加'; addRaceBtn.classList.replace('btn-success', 'btn-primary'); raceFormIds.forEach(id => { document.getElementById(id).value = ''; }); }
        function loadDataIntoForms() { document.querySelector(`input[name="mode"][value="${appData.mode}"]`).checked = true; Object.keys(appData.fictional).forEach(k => { const e = document.getElementById(`f-${k}`); if(e && !e.readOnly) e.value = appData.fictional[k]; }); Object.keys(appData.original).forEach(k => { const e = document.getElementById(`o-${k}`); if(e && !e.readOnly) e.value = appData.original[k]; }); }
        function getGradeClass(g) {
            if (!g) return 'grade-other';
            if (g.includes('Ⅰ')) return 'grade-g1';
            if (g.includes('Ⅱ')) return 'grade-g2';
            if (g.includes('Ⅲ')) return 'grade-g3';
            if (g === 'L') return 'grade-l';
            return 'grade-other';
        }
        function getRankClass(rank) {
            const rankNum = parseInt(rank, 10);
            if (rankNum === 1) return 'cell-rank-1';
            if (rankNum === 2) return 'cell-rank-2';
            if (rankNum === 3) return 'cell-rank-3';
            return '';
        }
        updateAllViews();
    });
    </script>
</body>
</html>
